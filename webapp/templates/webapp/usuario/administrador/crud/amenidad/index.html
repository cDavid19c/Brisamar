{% extends "cabezal.html" %}
{% load static %}
{% block bloquear_footer %}
{% endblock %}
{% block css_archivos %}
    <link rel="stylesheet" href="{% static 'webapp/css/usuario/administrador/crud/crud_helper.css' %}">
    <style>
        .badge-estado {
            font-size: .85rem;
            padding: .25rem .6rem;
            border-radius: 15px;
        }
    </style>
{% endblock %}

{% block contenido_pagina %}

    <!-- TOAST -->
    <div id="crud-toast-container"></div>

    <div class="container mt-4">

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="fw-bold">Amenidades</h2>
            <button class="btn btn-primary" onclick="abrirModalCrearAmenidad()">Crear Amenidad</button>
        </div>

        <div class="table-responsive">
            <table class="table table-striped" id="tablaAmenidades">
                <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Estado</th>
                    <th>Fecha</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- PAGINADOR -->
        <div id="paginacionAmenidades"
             class="d-flex justify-content-center align-items-center gap-3 mt-3">
        </div>

    </div>

    <!-- MODALES -->
    {% include "webapp/usuario/administrador/crud/amenidad/modal_crear.html" %}
    {% include "webapp/usuario/administrador/crud/amenidad/modal_editar.html" %}

{% endblock %}


{% block jvscript_archivos_defer %}
    <script src="{% static 'webapp/js/usuario/administrador/crud/crud_helper.js' %}"></script>

    <script>

        // ================== URLs ==================
        const URL_LIST = "/admin/amenidades/list/";
        const URL_CREATE = "/admin/amenidades/create/";
        const URL_GET = id => `/admin/amenidades/get/${id}/`;
        const URL_UPDATE = id => `/admin/amenidades/update/${id}/`;
        const URL_DELETE = id => `/admin/amenidades/delete/${id}/`;

        // ================== PAGINACIÓN ==================
        let PAGINA_ACTUAL = 1;

        // ================== CARGAR TABLA ==================
        function cargarAmenidades(page = 1) {

            PAGINA_ACTUAL = page;

            crudLoadTable(
                URL_LIST + `?page=${page}`,
                function (a) {

                    const estado = a.EstadoAmenidad
                        ? `<span class="badge bg-success badge-estado">Activo</span>`
                        : `<span class="badge bg-secondary badge-estado">Inactivo</span>`;

                    const eliminar = a.EstadoAmenidad
                        ? `<button class="btn btn-danger btn-sm"
                           onclick="eliminarAmenidad(${a.IdAmenidad})">
                        Eliminar
                   </button>`
                        : `<button class="btn btn-secondary btn-sm" disabled>
                        Eliminado
                   </button>`;

                    return `
                <tr class="${a.EstadoAmenidad ? "" : "table-secondary"}">
                    <td>${a.IdAmenidad}</td>
                    <td>${a.NombreAmenidad}</td>
                    <td>${estado}</td>
                    <td>${a.FechaModificacionAmenidad || ""}</td>
                    <td>
                        <button class="btn btn-warning btn-sm"
                                onclick="abrirModalEditarAmenidad(${a.IdAmenidad})">
                            Editar
                        </button>
                        ${eliminar}
                    </td>
                </tr>
            `;
                },
                "#tablaAmenidades",
                "#paginacionAmenidades",
                page
            );
        }

        // ================== CREAR ==================
        function abrirModalCrearAmenidad() {

            if (typeof crudGenerateNewId === "function") {
                crudGenerateNewId(URL_LIST, "#crear_IdAmenidad", "IdAmenidad");
            }

            $("#crear_NombreAmenidad").val("");

            $("#modalCrearAmenidad").modal("show");
        }

        function crearAmenidad() {

            const nombre = $("#crear_NombreAmenidad").val().trim();

            if (!nombre)
                return crudNotify("warning", "El nombre es obligatorio.");

            crudCreate(
                URL_CREATE,
                {
                    IdAmenidad: $("#crear_IdAmenidad").val(),
                    NombreAmenidad: nombre,
                    EstadoAmenidad: true
                },
                () => {
                    $("#modalCrearAmenidad").modal("hide");
                    cargarAmenidades(PAGINA_ACTUAL);
                }
            );
        }

        // ================== EDITAR ==================
        function abrirModalEditarAmenidad(id) {

            $.get(URL_GET(id), function (resp) {

                if (resp.status !== "ok")
                    return crudNotify("error", resp.message || "No se pudo cargar");

                const a = resp.data;

                $("#editar_IdAmenidad").val(a.IdAmenidad);
                $("#editar_NombreAmenidad").val(a.NombreAmenidad);
                $("#editar_EstadoAmenidad").prop("checked", !!a.EstadoAmenidad);

                $("#modalEditarAmenidad").modal("show");
            });
        }

        function actualizarAmenidad() {

            const id = $("#editar_IdAmenidad").val();
            const nombre = $("#editar_NombreAmenidad").val().trim();

            if (!nombre)
                return crudNotify("warning", "El nombre es obligatorio.");

            crudUpdate(
                URL_UPDATE(id),
                {
                    NombreAmenidad: nombre,
                    EstadoAmenidad: $("#editar_EstadoAmenidad").is(":checked")
                },
                () => {
                    $("#modalEditarAmenidad").modal("hide");
                    cargarAmenidades(PAGINA_ACTUAL);
                }
            );
        }

        // ================== ELIMINAR ==================
        function eliminarAmenidad(id) {

            crudConfirm("¿Está seguro de eliminar esta amenidad?")
                .then(ok => {
                    if (!ok) return;

                    crudDelete(
                        URL_DELETE(id),
                        () => cargarAmenidades(PAGINA_ACTUAL)
                    );
                });
        }

        // ================== INIT ==================
        $(document).ready(function () {

            // Definir reload global para paginación
            window.__crudReload = page => cargarAmenidades(page);

            // Cargar página inicial
            cargarAmenidades(1);

        });

    </script>

{% endblock %}
